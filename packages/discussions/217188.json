[
  {
    "Id": "459454",
    "ThreadId": "217188",
    "Html": "<p>Hi.</p>\r\n<p>My users&nbsp;are continuously getting the following exceptions when creating a task from my application :-</p>\r\n<ol>\r\n<li><span style=\"color:#ff0000\">System.UnauthorizedAccessException, Access is denied. (Exception from HRESULT: 0x80070005 (E_ACCESSDENIED)). <span style=\"color:#000000\">(User was logged in with Administrator rights.)</span></span></li>\r\n<li><span style=\"color:#ff0000\">System.Runtime.InteropServices.COMException, Cannot create a file when that file already exists. (Exception from HRESULT: 0x800700B7) <span style=\"color:#000000\">(User was creating Task for the 1st time)</span></span></li>\r\n<li><span style=\"color:#ff0000\"><span id=\"result_box\"><span>System.Runtime.InteropServices.COMException, Unable to establish the &quot;existence of the&quot; specified account.&nbsp;(Exception from HRESULT: 0x80041310) <span style=\"color:#000000\">(User was creating a task by passing user credentials to run the task even if he is not logged in - using variable&nbsp;<span style=\"color:#0000ff\">_runWhenUserNotLoggedIn</span> )</span></span></span></span></li>\r\n</ol>\r\n<p><span style=\"color:#000000\"><span>Note: The errors mentioned above were send by three different users.</span></span></p>\r\n<p>I was trying to simulate this problem on my side, but I'm not able simulate it.&nbsp; I gone through the code also, but didn't find anything wrong.<br>I'm sending you my code snippet, please help me to get rid of this problem.</p>\r\n<p>Dim taskService As New TaskService()<br>Dim taskFolder As TaskFolder = taskService.RootFolder<br>Dim taskDefinition As TaskDefinition = taskService.NewTask()</p>\r\n<p>taskDefinition.Data = &quot;&quot;</p>\r\n<p>If <span style=\"color:#0000ff\">_runWhenUserNotLoggedIn </span>= False Then<br><strong>&nbsp;&nbsp; </strong>taskDefinition.Principal.UserId = String.Concat(Environment.UserDomainName, &quot;\\&quot;, Environment.UserName)<strong> 'I thought this statement is causing the problem, but its working fine over my side</strong><br>&nbsp;&nbsp; taskDefinition.Principal.LogonType = TaskLogonType.InteractiveToken<br>End If</p>\r\n<p>taskDefinition.RegistrationInfo.Author = STR_Author<br>taskDefinition.RegistrationInfo.Description = &quot;&quot;<br>taskDefinition.RegistrationInfo.Documentation = &quot;&quot;<br>taskDefinition.Settings.DisallowStartIfOnBatteries = True<br>taskDefinition.Settings.Enabled = Me.Enabled<br>taskDefinition.Settings.Hidden = False<br>taskDefinition.Settings.RunOnlyIfIdle = False<br>taskDefinition.Settings.IdleSettings.IdleDuration = TimeSpan.FromMinutes(20)<br>taskDefinition.Settings.IdleSettings.WaitTimeout = TimeSpan.FromMinutes(10)<br>taskDefinition.Settings.IdleSettings.StopOnIdleEnd = False<br>taskDefinition.Settings.IdleSettings.RestartOnIdle = False<br>taskDefinition.Settings.Priority = System.Diagnostics.ProcessPriorityClass.Normal<br>taskDefinition.Settings.RunOnlyIfNetworkAvailable = False<br>taskDefinition.Settings.StopIfGoingOnBatteries = True</p>\r\n<p>If newVersion Then<br>&nbsp;&nbsp; taskDefinition.Principal.RunLevel = TaskRunLevel.LUA<br>&nbsp;&nbsp; taskDefinition.Settings.AllowDemandStart = True<br>&nbsp;&nbsp; taskDefinition.Settings.AllowHardTerminate = True<br>&nbsp;&nbsp; taskDefinition.Settings.Compatibility = TaskCompatibility.V2<br>&nbsp;&nbsp; taskDefinition.Settings.ExecutionTimeLimit = TimeSpan.Zero<br>&nbsp;&nbsp; taskDefinition.Settings.MultipleInstances = TaskInstancesPolicy.Parallel<br>&nbsp;&nbsp; taskDefinition.Settings.StartWhenAvailable = True<br>&nbsp;&nbsp; taskDefinition.Settings.WakeToRun = False<br>End If</p>\r\n<p>Dim runOnceTrigger As New TimeTrigger<br>runOnceTrigger.StartBoundary = 'Some date time here<br>runOnceTrigger.EndBoundary = 'some data time here<br>taskDefinition.Triggers.Add(runOnceTrigger)</p>\r\n<p>taskDefinition.Actions.Add(New ExecAction(&quot;My Application Path&quot;, &quot;My Arguments&quot;, System.Windows.Forms.Application.StartupPath))</p>\r\n<p>If <span style=\"color:#0000ff\">_runWhenUserNotLoggedIn </span>= False Then<br>&nbsp;&nbsp;&nbsp; taskFolder.RegisterTaskDefinition(taskPath, taskDefinition)<br>Else<br>&nbsp;&nbsp;&nbsp; taskFolder.RegisterTaskDefinition(taskPath, taskDefinition, TaskCreation.CreateOrUpdate,&nbsp;String.Concat(Environment.UserDomainName, &quot;\\&quot;, Environment.UserName), &quot;User Specified Password&quot;,&nbsp;TaskLogonType.InteractiveTokenOrPassword, &quot;&quot;)<br>End If</p>\r\n<p><br>Thank you!</p>",
    "PostedDate": "2010-06-24T05:09:33.82-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "463710",
    "ThreadId": "217188",
    "Html": "<p>Hey guys, still I have not found the solution of above mentioned problems.</p>\r\n<p>Now I'm trying to create a task which will run in any user account.&nbsp; If anybody knows how to do it, then please reply soon.</p>\r\n<p>Thank You!</p>",
    "PostedDate": "2010-07-06T05:34:17.553-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "464282",
    "ThreadId": "217188",
    "Html": "<p>These are tough ones to debug, but I will give you my thoughts on each error in hopes that it will help you find these needles in your haystack.</p>\r\n<p>1. System.UnauthorizedAccessException, Access is denied. (Exception from HRESULT: 0x80070005 (E_ACCESSDENIED)). (User was logged in with Administrator rights.) <br><span style=\"color:#ff0000\">&gt;&gt; This could be a problem with the file system. An administrator should always be able to register a task.</span><br>2. System.Runtime.InteropServices.COMException, Cannot create a file when that file already exists. (Exception from HRESULT: 0x800700B7) (User was creating Task for the 1st time) <br><span style=\"color:#ff0000\">&gt;&gt; If this was V1, then for sure this is a file system ACL problem on the %WINDOWS%\\tasks directory. If V2, then this could be a registry ACL problem.</span><br>3. System.Runtime.InteropServices.COMException, Unable to establish the &quot;existence of the&quot; specified account. (Exception from HRESULT: 0x80041310) (User was creating a task by passing user credentials to run the task even if he is not logged in - using variable _runWhenUserNotLoggedIn ) <br><span style=\"color:#ff0000\">&gt;&gt; This just sounds like a system error with the host not being to reach the AD server.</span></p>\r\n<p>Do you know which OS each of these errors is occuring on? Have you checked the Microsoft KB to see if there are system problems causing these errors?</p>",
    "PostedDate": "2010-07-07T07:21:36.197-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "477777",
    "ThreadId": "217188",
    "Html": "<p>I had the 0x80070005 (E_ACCESSDENIED) exception occuring on a Windows Server 2008 machine. The only way that I was able to resolve this was by using impersonation, oddly enough, with the same domain / user / password that I was using in the TaskService constructor, e.g.</p>\r\n<p><span style=\"color:blue\">this</span>.TaskService = <span style=\"color:blue\">new</span> TaskService(<span style=\"color:blue\">this</span>.ComputerName, <span style=\"color:blue\">this</span>.UserName, <span style=\"color:blue\">this</span>.Domain, <span style=\"color:blue\">this</span>.Password);</p>\r\n<p>did not work but</p>\r\n<p>context = <span style=\"color:blue\">new</span> WrapperImpersonationContext(<span style=\"color:blue\">this</span>.Domain, <span style=\"color:blue\">this</span>.UserName, <span style=\"color:blue\">this</span>.Password);<br>context.Enter();<br><span style=\"color:blue\">this</span>.TaskService = <span style=\"color:blue\">new</span> TaskService(<span style=\"color:blue\">this</span>.ComputerName);</p>\r\n<p>did work. I wanted to share this with users in case they run into this problem. The impersonation context wrapper was taken from <a href=\"http://www.vanotegem.nl/PermaLink,guid,36633846-2eca-40fe-9957-2859d8a244dc.aspx\">http://www.vanotegem.nl/PermaLink,guid,36633846-2eca-40fe-9957-2859d8a244dc.aspx</a></p>\r\n<p>&nbsp;</p>\r\n<p>&nbsp;</p>\r\n<p>&nbsp;</p>",
    "PostedDate": "2010-08-08T09:08:03.86-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  }
]